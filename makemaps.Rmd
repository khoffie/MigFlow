```{r packages-functions}

library(data.table)
library(sf)
library(MigStat)
library(ggplot2)
library(patchwork)
library(dotwhisker)
library(kableExtra)
source("functions.R")

read_output <- function(path, type, model = "us") {
    age_lvls <- c("below18", "18-25", "25-30", "30-50", "50-65", "above65")
    read_agegroup <- function(path, file) {
        dt <- data.table::fread(file.path(path, file))
        dt[, agegroup := get_age(file)]
    return(dt)
}
    get_age <- function(file) {
        age <- data.table::tstrsplit(file, "_")[[2]]
        age <- data.table::tstrsplit(age, "\\.")[[1]]
        return(age)
    }
    dt <- data.table::rbindlist(lapply(list.files(path, pattern = type),
                                       function(x) fread_agegroup(path, x)))
    dt[, agegroup := factor(agegroup, levels = age_lvls)]
    dt[, model := model]
    return(dt)
}

make_map <- function(dt, type = c("desir", "net")) {
    type <- match.arg(type)
    age <- dt[, unique(agegroup)]
    if(type == "desir") {
        map <- ggplot(set_geom(dt, F)) +
            geom_sf(aes(fill = desirability)) +
            ggtitle(sprintf("%s, estimated desirability", age))
    }
    if(type == "net") {
        map <- ggplot(set_geom(dt, F)) +
            geom_sf(aes(fill = net / pop_all * 100)) +
            ggtitle(sprintf("%s, Net migration", age))
    }
    return(map)
}

make_agemaps <- function(dt) {
    desir_map <- make_map(dt, "desir")
    net_map <- make_map(dt, "net")
    return(desir_map + net_map)
}

```

```{r read-data}

path <- "./manuscript_input/bu"
dt_geog <- read_output(path, "geog")
dt_dens <- read_output(path, "densfun")
dt_flows <- read_output(path, "flows")
dt_flows[, resid1 := (flows - preds) / preds]
dt_flows[, resid2 := sign(resid1) * log(1 + abs(resid1))]

dt_params <- read_output(path, "params")
shp <- setDT(sf::read_sf("~/Diss/inst/extdata/clean/shapes/districts.shp"))
shp[, AGS := as.integer(AGS)]
districts <- fread("./data/districts.csv")

net <- calculate_net(dt_flows, "flows", by = c("year", "agegroup"))
dt_geog[net, net := i.net, on = .(distcode = region, year, agegroup)]
dt_geog[shp, geometry := i.geometry, on = .(distcode = AGS)]
dt_geog[districts, pop_all := i.pop, on = .(distcode, year)]

ages <- dt_flows[, unique(agegroup)]

```

```{r desirability-maps, eval = FALSE}

## lapply(ages, function(x) make_agemaps(dt_geog[agegroup == x]))
## bug?

```

```{r params-plt}

gravity_pars <- c("a", "c", "d0", "dscale", "neterr", "ktopop")
dt_gravity_pars <- dt_params[parname %in% gravity_pars, .(paramval, parname, agegroup)]
setnames(dt_gravity_pars, c("parname", "paramval", "agegroup"),
         c("term", "estimate", "model"))

ggplot(dt_gravity_pars) +
    geom_point(aes(model, estimate)) +
    coord_flip() +
    facet_wrap(~term, scale = "free") +
    theme_minimal()

```

```{r, invent-flows, results = "show"}

invent <- dt_flows[, .(all_actual = sum(flows),
                 all_predicted = sum(preds)), keyby = .(agegroup, year, model)][
  , rel_diff := (all_actual - all_predicted) / all_actual][]
kable(dcast(invent, agegroup + all_actual ~ model, value.var = "all_predicted"),
    caption = "Do our models invent flows? Every column shows total flows: Observed and from two models")

```




