--- 
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
always_allow_html: true
---


```{r global_knitr, echo = FALSE, eval = TRUE}

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      fig.width = 6,
                      fig.asp = 0.7,
                      out.width = "100%")

```

```{r packages}

library(data.table)
library(sf)
library(MigStat)
library(ggplot2)
library(patchwork)
library(dotwhisker)
library(kableExtra)
library(helpeR)

```

```{r read-data}

read_output <- function(path, type, model = "US-model") {
    age_lvls <- c("below18", "18-25", "25-30", "30-50", "50-65", "above65")
    read_agegroup <- function(path, file) {
        dt <- data.table::fread(file.path(path, file))
        dt[, agegroup := get_age(file)]
    return(dt)
}
    get_age <- function(file) {
        age <- data.table::tstrsplit(file, "_")[[2]]
        age <- data.table::tstrsplit(age, "\\.")[[1]]
        return(age)
    }
    dt <- data.table::rbindlist(lapply(list.files(path, pattern = type),
                                       function(x) read_agegroup(path, x)))
    dt[, agegroup := factor(agegroup, levels = age_lvls)]
    dt[, model := model]
    return(dt)
}

path <- "./manuscript_input/bu"
districts <- fread("./data/districts.csv")
dt_geog <- read_output(path, "geog")
dt_dens <- read_output(path, "densfun")
dt_flows <- read_output(path, "flows")
dt_flows[, resid1 := (flows - preds) / preds]
dt_flows[, resid2 := sign(resid1) * log(1 + abs(resid1))]
dt_flows[districts, fromdens := i.density, on = .(fromdist = distcode, year)]
dt_flows[districts, todens := i.density, on = .(todist = distcode, year)]

dt_params <- read_output(path, "params")
shp <- setDT(sf::read_sf("~/Diss/inst/extdata/clean/shapes/districts.shp"))
shp[, AGS := as.integer(AGS)]


net <- calculate_net(dt_flows, "flows", by = c("year", "agegroup"))
dt_geog[net, net := i.net, on = .(distcode = region, year, agegroup)]
dt_geog[shp, geometry := i.geometry, on = .(distcode = AGS)]
dt_geog[districts, pop_all := i.pop, on = .(distcode, year)]

ages <- dt_flows[, unique(agegroup)]

```

## Model fit and diagnostic plots of individual flows
```{r impute-actual-flows}

impute_actual_zeros <- function(dt, mean = -15) {
    dt[, actual_imp := as.double(flows)]
    rnds <- rlnorm(dt[flows == 0, .N], mean, log(2.0))
    dt[flows == 0, actual_imp := rnds]
    return(NULL)
}

impute_actual_zeros(dt_flows, -10)

```

```{r model-fit}

plot_fit(dt_flows[flows > 0], log(preds), log(actual_imp), th_min = 0, p_sample = .1) +
    ggtitle("10 percent sample of individual flows, only for positive actual flows")

plot_fit(dt_flows, log(preds), log(actual_imp), th_min = 0, p_sample = .1) 

```

```{r, flows-distance1, eval = TRUE, fig.cap = caption}

caption <- "actualimp: True 0 flows were imputed using lognormal with mean = -15"
plot_fit(dt_flows, dist, log(actual_imp / preds), th_min = 0, smooth = FALSE, p_sample = .1)
## w <- 8
## ggsave("~/Desktop/plot_imp.pdf", width = w, height = w / 1.6)

```

```{r, flows-pop}

plot_fit(dt_flows, log(frompop * topop), log(actual_imp/preds),
         th_min = 0, p_sample = .1, smooth = FALSE)

```

```{r, flows-density, eval = TRUE}

plt1 <- plot_fit(dt_flows, log(fromdens), log(actual_imp/preds), 0, p_sample = 1, smooth = FALSE)
plt2 <- plot_fit(dt_flows, log(todens), log(actual_imp/preds), 0, p_sample = 1, smooth = FALSE)
plt3 <- plot_fit(dt_flows, log(fromdens * todens), log(actual_imp/preds), 0, p_sample = .1, smooth = FALSE)

## plt1 + plt2
plt3

```

## Desirability Maps
```{r desirability-maps, out.width = "120%", fig.width = 10}

make_map <- function(dt, type = c("desir", "net")) {
    type <- match.arg(type)
    age <- dt[, unique(agegroup)]
    if(type == "desir") {
        map <- ggplot(set_geom(dt, F)) +
            geom_sf(aes(fill = desirability)) +
            ggtitle(sprintf("%s, estimated desirability", age))
    }
    if(type == "net") {
        map <- ggplot(set_geom(dt, F)) +
            geom_sf(aes(fill = net / pop_all * 100)) +
            ggtitle(sprintf("%s, Net migration", age))
    }
    map <- map +
        theme(legend.position = "top") +
        theme_bw()
    return(map)
}

make_agemaps <- function(dt) {
    desir_map <- make_map(dt, "desir")
    net_map <- make_map(dt, "net")
    return(desir_map + net_map)
}

lapply(levels(ages), function(age) make_agemaps(dt_geog[agegroup == age]))

```

```{r density}



```

## Optimal Parameters
```{r params-plt}

plot_coefs <- function(dt, params = c("a", "c", "d0", "dscale", "neterr", "ktopop")) {
    params <- params
    dt2 <- dt[parname %in% params, .(paramval, parname, agegroup)]
    setnames(dt2, c("parname", "paramval", "agegroup"),
             c("term", "estimate", "model"))
    plt <- ggplot(dt2) +
        geom_point(aes(model, estimate)) +
        scale_x_discrete(limits = rev) +
        coord_flip() +
        facet_wrap(~term, scale = "free") +
        theme_minimal() +
        ggtitle("Optimal Gravity Parameters")
    return(plt)
}

plot_coefs(dt_params)

```

## Further Diagnostics
```{r, invent-flows, results = "show"}

calc_flowinvention <- function(dt) {
    invent <- dt[, .(all_actual = sum(flows),
                 all_predicted = sum(preds)), keyby = .(agegroup, year, model)][
      , rel_diff := round((all_predicted - all_actual) / all_actual * 100, 2)][]
    return(invent)
}

invent <- calc_flowinvention(dt_flows)
## dcast(invent, agegroup + all_actual + all_predicted + rel_diff ~ model, value.var = "all_predicted")
kable(invent, caption = "Do our models invent flows? Every column shows total flows: Observed and from two models")

```


