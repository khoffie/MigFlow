--- 
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
always_allow_html: true
---

```{r global_knitr, echo = FALSE, eval = TRUE}

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      fig.width = 8,
                      fig.asp = 0.7,
                      out.width = "120%")

## ---
## title: "Using bookdown with Beamer"
## output:
##   bookdown::pdf_book:
##     base_format: "function(..., number_sections) rmarkdown::beamer_presentation(...)"
##     number_sections: false
## ---

```

```{r, packages}

library(data.table)
library(sf)
library(ggplot2)
library(MigStat)
library(plotR)
library(kableExtra)
library(patchwork)
source("functions.R")
source("functions_plots.R")

```

```{r read-data, message = TRUE}

preds_th <- 3
age_lvls <- c("below18", "18-25", "25-30", "30-50", "50-65", "above65")
map_age <- age_lvls ## for maps
use_age <- age_lvls ## for everything else
setwd("~/Documents/GermanMigration/")

data <- read_data("works")
dt <-setnames(data$preds, c("flows", "preds3"), c("actual", "preds"), skip_absent = TRUE)
dists <- fread("data/districts.csv")
shp <- setDT(sf::read_sf(file.path(p_clean, "shapes/districts_ext.shp")))

## Think about extracting all of this from actually used data!
## p_clean <- "~/Diss/inst/extdata/clean/"
## pop_dt <- fread(file.path(p_clean, "aux_data/age17for.csv"))
## setnames(pop_dt, "age_group", "agegroup")
## rec_ages(pop_dt)

```

```{r, fit-gravity}

dt_grav <- copy(dt)
dt_grav[, preds := predict(fit_gravity(.SD, offset = FALSE), type = "response"),
        keyby = .(agegroup)]
dt_grav[, model := "gravity"]

dt <- rbind(dt, dt_grav)

```

```{r, merge-data}

dtm <- melt(dt, measure.vars = c("actual", "preds"))
## order_models(dt)
dt <- dt[agegroup %in% use_age]
dt[, agegroup := factor(agegroup, levels = age_lvls)]
dt[, resid1 := (actual - preds) / preds]
dt[, resid2 := sign(resid1) * log(1 + abs(resid1))]

### order_models(dt_coefs)
dt_coefs <- data$coefs
dt_coefs[, diff := values - inits]

```

```{r, invent-flows, results = "show"}

invent <- dt[, .(all_actual = sum(actual),
                 all_predicted = sum(preds)), keyby = .(agegroup, model)][
  , rel_diff := (all_actual - all_predicted) / all_actual][]
kbl(dcast(invent, agegroup + all_actual ~ model, value.var = "all_predicted"),
    caption = "Do our models invent flows? Every column shows total flows: Observed and from two models")

```

```{r, diff-plt, fig.cap = caption}

caption <- "Distribution of differences between optimal values and initial values."

ggplot(dt_coefs, aes(values)) +
    geom_density() +
    facet_wrap(vars(model), scale = "free") +
    theme_minimal() +
    ggtitle("opti coefs")

ggplot(dt_coefs, aes(values - inits)) +
    geom_density() +
    facet_wrap(vars(model)) +
    theme_minimal() +
    ggtitle("opti - init")

```

```{r data}

## dt
dtm <- melt(dt, measure.vars = c("preds", "resid1", "resid2"), variable.name = "type")
dtm <- melt(dt, measure.vars = c("preds"), variable.name = "type")

net1 <- calculate_net(dt, col = "actual", by = c("year", "agegroup", "model"),
                      long = TRUE, type = "actual")
net2 <- calculate_net(dt, col = "preds", by = c("year", "agegroup", "model"),
                      long = TRUE, type = "preds")
net <- rbind(net1, net2)
net2 <- dcast(net[variable == "net"], region + year + agegroup ~ type)

## net[pop_dt, pop := i.german, on = .(region, year, agegroup)]
## net[, value := value / pop * 100]
net <- dcast(net[variable == "net"], region + year + agegroup + model ~ type, value.var = "value")
net[shp, geometry := i.geometry, on = .(region = AGS)]

## ggplot(net, aes(agegroup, actual, fill = agegroup)) +
##     geom_violin() +
##     ggtitle("Actual net migration rate: Net migration in % of pop of agegroup") +
##     theme_minimal()

```

```{r, coef-table, results = "show", eval = TRUE}

kbl(dt_coefs, digits = 2, booktabs = TRUE, longtable = TRUE,
    caption = "Parameters")

```

## Maps
```{r make-maps, out.width = "99%", eval = FALSE}

net[, diff := actual - preds]
netm <- melt(net,
             measure.vars = c("actual", "preds", "diff"),
             variable.name = "type")
##netm[, value := sign(value) * log(1 + abs(value))]

lapply(map_age, function(age) make_net_map(netm[agegroup == age & type %in% c("actual", "preds")]))

```

## Net chart
```{r net-plot, eval = FALSE}

make_net_plot(net, type = "univariate", scales = "free") 
## net[, cor(actual, preds), keyby = .(agegroup, year, model)]

```

## Individual Flows

```{r, flows-marginal}

dtm <- melt(dt, measure.vars = c("actual", "preds"))
ggplot(dtm, aes(log(value), color = variable)) +
    geom_density() +
    facet_wrap(vars(agegroup))

```

```{r individual-resids-violin}

sub1 <- sprintf("Residuals sign(resid) * log(1 + abs(resid)), only preds > %s are shown", preds_th)
resid_plt <- ggplot(dt[preds > preds_th],
                    aes(agegroup, resid2, fill = agegroup)) +
    geom_violin() +
    facet_wrap(vars(model))
prettify(resid_plt,
         main = "Individual Flows Residuals sign(resid) * log(1 + abs(resid))",
         sub = sub1)

sub2 <- sprintf("resid = (actual - preds) / preds, only preds > %s are shown", preds_th)
resid_plt <- ggplot(dt[preds > preds_th],
                    aes(agegroup, resid1, fill = agegroup)) +
    geom_violin() +
    facet_wrap(vars(model))
prettify(resid_plt, main = "Individual Flows",
         sub = sub2)

```

## distance
```{r, flows-distance1, eval = TRUE, fig.cap = caption}

caption <- "actualimp: True 0 flows were imputed using lognormal with mean = -15"
dt[, actual_imp := as.double(actual)]
rnds <- rlnorm(dt[actual == 0, .N], -15, log(2.0))
dt[actual == 0, actual_imp := rnds]

plot_fit(dt, distance, log(actual_imp / preds), th_min = 0, smooth = FALSE, p_sample = 1)
w <- 8
ggsave("~/Desktop/plot_imp.pdf", width = w, height = w / 1.6)

```

```{r, flows-distance2, fig.cap = caption}

caption <- "Here actuals are shown, that means all 0 flows are missing."
plot_fit(dt, distance, log(actual / preds), th_min = 0, smooth = TRUE, p_sample = 1)
w <- 8
ggsave("~/Desktop/plot_noimp.pdf", width = w, height = w / 1.6)

## plot_fit(dt, preds, (actual - preds) / preds, th_min = 3, th_max = 50, p_sample = 1, smooth = FALSE) 
## plot_fit(dt, preds, sign((actual - preds) / preds) * log(0 + ((actual - preds) / preds)) , 1, 50, p_sample = 1, smooth = FALSE)

```

```{r, flows-distance3, fig.cap = caption}

caption <- "actualimp2, actual 0 flows were imputed using lognormal with mean 0."
dt[, actual_imp2 := as.double(actual)]
rnds <- rlnorm(dt[actual == 0, .N], 0, log(2.0))
dt[actual == 0, actual_imp2 := rnds]
plot_fit(dt, distance, log(actual_imp2 / preds), th_min = 0, smooth = TRUE, p_sample = 1)
w <- 8
ggsave("~/Desktop/plot_imp2.pdf", width = w, height = w / 1.6)

```

### Population

```{r, flows-pop}

plot_fit(dt, log(frompop * topop), log(actual_imp/preds), th_min = 0, p_sample = 1, smooth = FALSE)

```

### density
```{r, flows-density, eval = TRUE}

dt[density, fromdens := i.density, on = .(fromdist = region, year)]
dt[density, todens := i.density, on = .(todist = region, year)]

plt1 <- plot_fit(dt, log(fromdens), log(actual_imp/preds), 0, p_sample = 1, smooth = FALSE)
plt2 <- plot_fit(dt, log(todens), log(actual_imp/preds), 0, p_sample = 1, smooth = FALSE)
plt3 <- plot_fit(dt, log(fromdens * todens), log(actual_imp/preds), 0, p_sample = 1, smooth = FALSE)

## plt1 + plt2
plt3

```

```{r, eval = FALSE}



coefs <- dt[, .(fits = .(broom::tidy(fit_gravity(.SD, offset = FALSE)))), keyby = agegroup]
coefs <- rbindlist(coefs[, fits])
coefs[, mean(estimate), keyby = .(term)]
coefs[term == "(Intercept)"]

logistic(-11)

exp(-11)




dt[actual == 0, actual_imp := rnorm(1, 0, 100)]


dt[actual == 0 & actual_imp != 0]
dt[, mean(actual == 0), keyby = agegroup]

ggplot(dt, aes(distance, log(actual_imp, preds))) +
    geom_point() +
    facet_wrap(~agegroup)

```
