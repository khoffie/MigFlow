--- 
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
always_allow_html: true
---


```{r global_knitr, echo = FALSE, eval = TRUE}

knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      results = "hide",
                      fig.width = 8,
                      fig.asp = 0.7,
                      out.width = "120%")

```

```{r fun-pck}

library(data.table)
library(sf)
library(ggplot2)
library(MigStat)
library(plotR)

calculate_net <- function(dt, col, by, o = "fromdist", d = "todist",
                           long = FALSE, type = NULL) {
    dt_in <- dt[, .(inflow = sum(get(col))), keyby = c(d, by)]
    dt_out <- dt[, .(outflow = sum(get(col))), keyby = c(o, by)]
    dt_in[dt_out, outflow := i.outflow, on = c(setNames(o, d), by)]
    dt_in[, net := inflow - outflow]
    setnames(dt_in, d, "region")
    if(!is.null(type)) {
        dt_in[, type := type]
        id_vars <- c("type", "region", by)
    }
    if(is.null(type)) {
        id_vars <- c("region", by)
    }
    if(long == TRUE) {
        dt_in <- melt(dt_in, id.vars = id_vars)
    }
    return(dt_in)
}

make_map <- function(netm, age) {
    plt <- ggplot(set_geom(netm[agegroup == age], F)) +
        geom_sf(aes(fill = value)) +
        facet_wrap(~variable) +
        ggtitle(sprintf("Actual and predicted nmr (normalized by pop of Germans) for age group %s", age)) +
        theme_minimal() 
    return(plt)
}

make_net_plot <- function(net, scales = "free") {
    plt <- ggplot(net, aes(preds, actual)) +
        geom_hline(yintercept = 0, col = "blue", linewidth = .2) +
        geom_vline(xintercept = 0, col = "blue", linewidth = .2) +        
        geom_point(alpha = .5) +
        facet_wrap(vars(agegroup, year), scales = scales) +
        theme_minimal() +
        ggtitle("Net migration rate(400 regions, normalized by pop of Germans)")
    return(plt)
}

```

```{r data}

age_lvls <- c("below18", "18-25", "25-30", "30-50", "50-65", "above65")
use_age <- age_lvls
p_out <- "~/Documents/GermanMigration/plots"
p_in <- "~/Documents/GermanMigration/data"
f_optis <- "opti_model3.csv"
f_preds <- "FlowDataPreds3.csv"
shp <- setDT(sf::read_sf(file.path("~/Diss/inst/extdata/clean/shapes", "districts_ext.shp")))
dt_coefs <- fread(file.path(p_in, f_optis))

dt <- fread(file.path(p_in, f_preds))
setnames(dt, "preds3", "preds")
dt <- dt[agegroup %in% use_age]
pop_dt <- dt[, .SD[1], keyby = .(fromdist, agegroup, year)][
  , .(region = fromdist, agegroup, year, pop = frompop_ger)]
dt <- dt[, .(fromdist, todist, year, agegroup, distance, flows, preds)]
age_lvls <- intersect(age_lvls, use_age)
dt[, agegroup := factor(agegroup, levels = age_lvls)]
setnames(dt, "flows", "actual")
dtm <- melt(dt,
            id.vars = setdiff(colnames(dt), c("preds", "actual")),
            value.vars = c("preds", "actual"),
            variable.name = "model")

## probably much easier
net <- calculate_net(dtm, col = "value", by = c("year", "agegroup", "model"), long = TRUE)[variable == "net"]
net[pop_dt, pop := i.pop, on = .(region, year, agegroup)]
net[, value := value / (pop * 1000) * 100] # in %, pop is in 1000
net <- dcast(net, region + year + agegroup ~ model, value.var = "value")
net[, actual_s := sign(actual) * log(1 + abs(actual))]
net[, preds_s := sign(preds) * log(1 + abs(preds))]
netm <- melt(net, id.vars = c("region", "year", "agegroup"))
netm <- netm[variable %in% c("actual_s", "preds_s")]
netm[shp, geometry := i.geometry, on = .(region = AGS)]

```

```{r, opti-ini}

ggplot(dt_coefs, aes(values -inits)) +
    geom_density() +
    ggtitle("optis - inits")

```


## Maps
```{r make-maps}

lapply(age_lvls, function(age) make_map(netm, age))

```

## Net chart
```{r net-plot}

make_net_plot(net, scales = "free")

```

## Individual Flows

```{r individual-resids-violin}

dt[, resid1 := (actual - preds) / preds]
dt[, resid2 := sign(resid1) * log(1 + abs(resid1))]

resid_plt <- ggplot(dt, aes(agegroup, resid2, fill = agegroup)) +
    geom_violin() 
prettify(resid_plt, main = "Individual Flows Residuals sign(resid) * log(1 + abs(resid))",
         sub = "Residuals sign(resid) * log(1 + abs(resid))")

resid_plt <- ggplot(dt, aes(agegroup, resid1, fill = agegroup)) +
    geom_violin() 
prettify(resid_plt, main = "Individual Flows",
         sub = "resid = (actual - preds) / preds")

```

```{r, preds-resid, eval = TRUE}

ggplot(dt, aes(log(preds), log(actual))) +
    geom_point(pch = ".") +
    geom_smooth(se = FALSE) +
    facet_wrap(vars(agegroup), scale = "free") +
    ggtitle("individual flows, log(preds) v log(actual)") +
    theme_minimal()

ggplot(dt, aes(log(preds), log(actual / preds))) +
    geom_point(pch = ".") +
    geom_smooth(se = FALSE) +
    facet_wrap(vars(agegroup), scale = "free") +
    ggtitle("individual flows, log(preds) v log(actual/preds)") +
    theme_minimal()

ggplot(dt, aes(preds, resid1)) +
    geom_point(pch = ".") +
    xlim(c(0, 50)) +
    geom_smooth(se = FALSE) +
    facet_wrap(vars(agegroup), scale = "free") +
    ggtitle("individual flows, pred < 50, (actual - pred) / pred") +
    theme_minimal()

ggplot(dt, aes(preds, resid2)) +
    geom_point(pch = ".") +
    xlim(c(0, 50)) +
    geom_smooth(se = FALSE) +
    facet_wrap(vars(agegroup), scale = "free") +
    ggtitle("individual flows, pred < 50, sign(r) * log(1 + abs(r))") +
    theme_minimal()

```

```{r, eval = FALSE}

head(dt[order(- preds)], 20)

dt_coords[distcode == 2000]
flows[fromdist == 2000]

dt[order(flows)]

dt[, cor(log(flows), log(preds3)), keyby = agegroup]
dt[, cor((flows), (preds3)), keyby = agegroup]

dt[, cor(log(flows), log(preds)), keyby = agegroup]
dt[, cor((actual), (preds)), keyby = agegroup]

dt[agegroup == "above65", ][order(preds)]

```
