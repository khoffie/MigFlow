```{r}

ggsavew <- function(w = 8, ...) {
    w <- w
    h <- w / 1.6
    ggsave(..., width = w, height = h)
}

dt <- fread("data/FlowDataGermans.csv")
dt <-setnames(dt, c("flows", "dist"), c("actual", "distance"), skip_absent = TRUE)
dists <- fread("data/districts.csv")

kable(dt[, .(frac_0 = mean(actual == 0)), keyby = .(agegroup)], digits = 2)

dt[dists, frombl := i.bl_ags, on = .(fromdist = distcode)]
dt[dists, tobl := i.bl_ags, on = .(todist = distcode)]
dt[dists, fromdens := i.density, on = .(fromdist = distcode)]
dt[dists, todens := i.density, on = .(todist = distcode)]


all <- dt[, .(all = sum(actual)), keyby = .(agegroup, year)]
dt[all, ww := actual / i.all, on = .(agegroup, year)]
dt[, fromsax := fifelse(frombl == 14, TRUE, FALSE)]
dt[, tosax := fifelse(tobl == 14, TRUE, FALSE)]

test <- dt[(fromsax == TRUE & tosax == FALSE) | (fromsax == FALSE & tosax == TRUE),
   .SD[sample(.N, size = min(.N, 1e3))], keyby = .(tosax, fromsax)]

melt(test[, .(tosax, fromsax, agegroup, distance)],
     id.vars = "agegroup", )

ggplot(test,
       aes(distance) +
    geom_density(linewidth = 2) +
    facet_wrap(vars(agegroup)) +
    theme_minimal()

ggplot(rbind(sample_in, sample_out),
       aes(distance, color = type)) +
    geom_density(linewidth = 2) +
    facet_wrap(~agegroup) +
    theme_minimal()

ggsavew(filename = "~/Desktop/inout.pdf")

```
